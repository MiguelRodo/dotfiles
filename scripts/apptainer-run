#!/usr/bin/env bash
set -euo pipefail

# parse your flags into args_for_path
args_for_path=()
custom_command=()
while [[ $# -gt 0 ]]; do
  case $1 in
    -s|--sif)           args_for_path+=(--sif "$2");   shift 2;;
    -d|--directory)     args_for_path+=(--directory "$2"); shift 2;;
    -h|--help)          usage;;
    --)                 shift; custom_command=( "$@" ); break;;
    -*|--*)             usage;;
    *)                  custom_command+=( "$1" ); shift;;
  esac
done

if sif_path=$(apptainer-path "${args_for_path[@]}"); then
  echo "Found: $sif_path"
else
  echo "Error: no SIF found" >&2
  exit 1
fi

# run inside container (exec replaces this script with the apptainer process)
if (( ${#custom_command[@]} )); then
  echo "Executing: ${custom_command[*]}"
  exec apptainer exec "$sif_path" "${custom_command[@]}"
else
  echo "Opening interactive shellâ€¦"
  exec apptainer shell "$sif_path"
fi
