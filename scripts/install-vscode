#!/usr/bin/env bash

set -e

# Function to display usage
usage() {
    echo "Usage: $0 [-d <install_dir>] [-b <bin_dir>]"
    echo "  -d, --install-dir <install_dir> : Directory to install VSCode (default: \$HOME/.vscode-linux-x64)"
    echo "  -b, --bin-dir <bin_dir>         : Directory to place symbolic links for code and code-tunnel (default: \$HOME/.local/bin)"
    echo "  -n, --no-link                   : If set, no symbolic links are created"
    echo ""
    echo "Description:"
    echo "  This script downloads and installs Visual Studio Code in a specified directory,"
    echo "  and creates symbolic links to the 'code' and 'code-tunnel' executables in the specified bin directory."
    echo ""
    echo "Examples:"
    echo "  $0"
    echo "  $0 -d \$HOME/.vscode -b \$HOME/.local/bin"
    exit 1
}

# Default values
install_dir="$HOME/.vscode-linux-x64"
bin_dir="$HOME/.local/bin"
create_link=true

# Parse named parameters
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -d|--install-dir) install_dir="$2"; shift 2 ;;
        -b|--bin-dir) bin_dir="$2"; shift 2 ;;
        -n|--no-link) create_link=false; shift ;; 
        -h|--help) usage ;;
        --) shift; break ;;
        -*|--*) echo "Unknown option: $1"; usage ;;
        *) echo "Unknown argument: $1"; usage ;;
    esac
done

# Ensure bin_dir exists
mkdir -p "$bin_dir"

# Create a temporary directory in /tmp for the download and extraction
tmp_dir=$(mktemp -d -t vscode-XXXXXX)
echo "Downloading Visual Studio Code to temporary directory: $tmp_dir"

# Download the latest version of Visual Studio Code
if ! wget https://update.code.visualstudio.com/latest/linux-x64/stable -O "$tmp_dir/vscode.tar.gz"; then
    echo "Error: Failed to download Visual Studio Code."
    exit 1
fi

# Extract the downloaded archive
echo "Extracting Visual Studio Code..."
if ! tar -xzf "$tmp_dir/vscode.tar.gz" -C "$tmp_dir"; then
    echo "Error: Failed to extract Visual Studio Code."
    exit 1
fi

# Move the extracted VSCode to the install_dir
echo "Installing Visual Studio Code to: $install_dir"
if ! mv "$tmp_dir/VSCode-linux-x64" "$install_dir"; then
    echo "Error: Failed to move Visual Studio Code to install directory."
    exit 1
fi

# Create symbolic links to the executables in bin_dir
if [ "$create_link" == "true" ]; then
    echo "Creating symbolic links in: $bin_dir"
    ln -sf "$install_dir/bin/code" "$bin_dir/code"
    ln -sf "$install_dir/bin/code-tunnel" "$bin_dir/code-tunnel"
fi

# Clean up the temporary directory
echo "Cleaning up temporary files..."
rm -rf "$tmp_dir"

echo "Installation complete!"
echo "VSCode is installed in: $install_dir"
echo "The 'code' and 'code-tunnel' executables are available in: $bin_dir"
echo "To verify, you can run: code --version or code-tunnel --version"
